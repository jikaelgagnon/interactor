(()=>{"use strict";class t{constructor(t,e){this.senderMethod=t,this.payload=e}}class e{constructor(t){this.url=t}}class n extends e{constructor(t,e,n,i){super(i),this.activityType=t,this.createdAt=new Date,this.eventType=e.type,this.metadata=n}}class i extends e{constructor(t){super(t),this.email="Email not set",this.startTime=new Date}setEmail(t){this.email=t}}class o{update(t,e,n){this.url=e;let i=this.updateMatchData(t,n);this.selectors=this.getSelectors(i,n)}updateMatchData(t,e){let n="";const i=Object.keys(e).filter((e=>{console.log(e);const i=new URLPattern(e,t).test(this.url);return i&&e.length>n.length&&(n=e),i}));return 0===i.length&&console.log("no matches found"),this.urlUsesId=n.endsWith(":id"),this.matchPathData=e[n],i}getIDFromPage(){var t,e;return(null===(e=(t=this.matchPathData).idSelector)||void 0===e?void 0:e.call(t))||""}getSelectors(t,e){let n=[];for(const i of t){let t=e[i];for(const e of t.selectors)n.push(e)}return n}checkForMatch(t){let e=new URL(this.url).pathname,n=new URL(t).pathname,i=e.split("/"),o=n.split("/");if(e.length!==n.length)return!1;let s=i.length-(this.urlUsesId?1:0);for(let t=0;t<s;t++)if(i[t]!==o[t])return!1;return!0}}var s,a;!function(t){t.SelfLoop="Self-Loop",t.StateChange="State Change",t.Interaction="Interaction"}(s||(s={})),function(t){t.InitializeSession="Initialize Session",t.InteractionDetection="Interaction Detection",t.NavigationDetection="Navigation Detection"}(a||(a={}));const r=JSON.parse('{"baseURL":"https://www.youtube.com","events":["pause","play","seeked","seeking","scroll","click","ended","input","keypress"],"paths":{"/shorts/:id":{"selectors":[{"selector":"ytd-player#player","name":"Shorts Video Player"}]}}}'),c=new class{constructor(t){this.config=t}addIDSelector(t,e){const n=this.config.paths;if(!(t in n))throw new Error("Trying to add ID selector to path that doesn't exist");n[t].idSelector=e}}(r);new class{constructor(t){this.StringToColor=function(){let t=null;return{next:function(e){return null===t&&(t={},t.stringToColorHash={},t.nextVeryDifferntColorIdx=0,t.veryDifferentColors=["#00FF00","#0000FF","#FF0000","#01FFFE","#FFA6FE","#FFDB66","#006401","#010067","#95003A","#007DB5","#FF00F6","#FFEEE8","#774D00","#90FB92","#0076FF","#D5FF00","#FF937E","#6A826C","#FF029D","#FE8900","#7A4782","#7E2DD2","#85A900","#FF0056","#A42400","#00AE7E","#683D3B","#BDC6FF","#263400","#BDD393","#00B917","#9E008E","#001544","#C28C9F","#FF74A3","#01D0FF","#004754","#E56FFE","#788231","#0E4CA1","#91D0CB","#BE9970","#968AE8","#BB8800","#43002C","#DEFF74","#00FFC6","#FFE502","#620E00","#008F9C","#98FF52","#7544B1","#B500FF","#00FF78","#FF6E41","#005F39","#6B6882","#5FAD4E","#A75740","#A5FFD2","#FFB167","#009BFF","#E85EBE"]),t.stringToColorHash[e]||(t.stringToColorHash[e]=t.veryDifferentColors[t.nextVeryDifferntColorIdx++],console.log(`%c The colour for ${e}`,`color: ${t.stringToColorHash[e]}`)),t.stringToColorHash[e]}}}(),this.interactionEvents=t.events?t.events:["click"],this.debug=!t.debug||t.debug,this.paths=t.paths,this.baseURL=t.baseURL,this.currentPageData=new o,this.interactionAttribute="monitoring-interactions",window.location.origin===this.baseURL?this.initializeMonitor():console.log(`Skipping monitoring. Current origin (${window.location.origin}) does not match base URL (${this.baseURL}).`)}initializeMonitor(){this.updateCurrentPageData(document.location.href),this.initializeSession(),this.bindEvents()}updateCurrentPageData(t){this.currentPageData.update(this.baseURL,t,this.paths)}initializeSession(){this.sendMessageToBackground(a.InitializeSession,this.getCurrentState())}bindEvents(){new MutationObserver(((t,e)=>this.addListenersToNewMatches())).observe(document.body,{childList:!0,subtree:!0}),navigation.addEventListener("navigate",(t=>this.onNavigationDetection(t)))}addListenersToNewMatches(){this.currentPageData.selectors.forEach((t=>{let e=document.querySelectorAll(`:is(${t.selector}):not([${this.interactionAttribute}])`),n=t.name;e.forEach((t=>{this.debug&&(t.style.border=`2px solid ${this.StringToColor.next(n)}`),t.setAttribute(this.interactionAttribute,"true"),new ResizeObserver((t=>{for(const e of t)console.log("Element",e.target,0===e.contentRect.width?"is now hidden":"is now visible")})).observe(t);for(let e=0;e<this.interactionEvents.length;e++)t.addEventListener(this.interactionEvents[e],(t=>{this.onInteractionDetection(t,n)}),!0)}))}))}createStateChangeRecord(t,e){const i={};let o=this.currentPageData.getIDFromPage();return""!=o&&(i.id=o),new n(s.StateChange,t,i,this.currentPageData.url)}createSelfLoopRecord(t,e){const i={};let o=this.currentPageData.getIDFromPage();return""!=o&&(i.id=o),new n(s.SelfLoop,t,i,this.currentPageData.url)}createInteractionRecord(t,e){const i={name:t};let o=this.currentPageData.getIDFromPage();return""!=o&&(i.id=o),new n(s.Interaction,e,i,this.currentPageData.url)}sendMessageToBackground(e,n){return i=this,o=void 0,a=function*(){let i=new t(e,n);return yield chrome.runtime.sendMessage(i)},new((s=void 0)||(s=Promise))((function(t,e){function n(t){try{c(a.next(t))}catch(t){e(t)}}function r(t){try{c(a.throw(t))}catch(t){e(t)}}function c(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(n,r)}c((a=a.apply(i,o||[])).next())}));var i,o,s,a}onInteractionDetection(t,e){console.log(`Event detected with event type: ${t.type}`);const n=this.createInteractionRecord(e,t);this.sendMessageToBackground(a.InteractionDetection,n)}onNavigationDetection(t){let e=!(t.destination.url===this.currentPageData.url);this.getCleanStateName(),this.currentPageData.url=t.destination.url;let n=this.getCleanStateName();if(console.log(`Navigation detected with event type: ${t.type}`),"push"===t.navigationType){this.updateCurrentPageData(this.currentPageData.url);const e=this.createStateChangeRecord(t,n);this.sendMessageToBackground(a.NavigationDetection,e)}else if("replace"===t.navigationType){const n=this.createSelfLoopRecord(t,e);this.sendMessageToBackground(a.NavigationDetection,n)}}getCleanStateName(){let t=new URL(this.currentPageData.url).pathname.split("/");return this.currentPageData.urlUsesId&&(t=t.slice(0,t.length-1)),t.join("/")}getCurrentState(){return new i(this.currentPageData.url)}}(c.config)})();